{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2><i class="bi bi-bar-chart"></i> Task Reports</h2>
    <hr class="section-separator">

    <!-- Filters -->
    <div class="report-controls">
        <form method="GET" action="{{ url_for('main.task_reports') }}" class="filter-section">
            <div class="filter-group">
                <label for="time_filter" class="filter-label"><i class="bi bi-calendar"></i> Time Period</label>
                <select name="time_filter" id="time_filter" onchange="this.form.submit()" class="filter-select">
                    <option value="last_week" {% if time_filter == 'last_week' %}selected{% endif %}>Last Week</option>
                    <option value="last_month" {% if time_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                    <option value="this_year" {% if time_filter == 'this_year' %}selected{% endif %}>This Year</option>
                    <option value="all" {% if time_filter == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="status_filter" class="filter-label"><i class="bi bi-check-circle"></i> Status</label>
                <select name="status_filter" id="status_filter" onchange="this.form.submit()" class="filter-select">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="finished" {% if status_filter == 'finished' %}selected{% endif %}>Finished</option>
                    <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
                </select>
            </div>
        </form>

        <div class="action-buttons">
            <button id="export-csv" class="btn btn-primary">
                <i class="bi bi-download"></i> Export to CSV
            </button>
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="summary-section">
        <div class="summary-card">
            <h4>Total Tasks</h4>
            <p>{{ summary.total_tasks }}</p>
        </div>
        <div class="summary-card">
            <h4>Completed Tasks</h4>
            <p>{{ summary.completed_tasks }}</p>
        </div>
        <div class="summary-card">
            <h4>Overdue Tasks</h4>
            <p>{{ summary.overdue_tasks }}</p>
        </div>
        <div class="summary-card">
            <h4>Completion Rate</h4>
            <p>{{ summary.completion_rate }}%</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-section">
        <div class="chart-card">
            <h4>Task Status Distribution</h4>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
            <h4>Task Priority Distribution</h4>
            <canvas id="priorityChart"></canvas>
        </div>
    </div>

    <!-- Task Table -->
    <div class="report-table-container">
        <h4>Task Details</h4>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Assigned To</th>
                    <th>Group</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Due Date</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody id="report-table-body">
                {% for task in tasks %}
                <tr>
                    <td>{{ task.title }}</td>
                    <td>{{ task.assignee.first_name }} {{ task.assignee.last_name if task.assignee else 'Unassigned' }}</td>
                    <td>{{ task.assignee.group or 'N/A' }}</td>
                    <td class="status-{{ task.status }}">{{ task.status | capitalize }}</td>
                    <td class="priority-{{ task.priority }}">{{ task.priority | capitalize }}</td>
                    <td>{{ task.due_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M IRST') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <button class="btn btn-secondary" id="prev-page" disabled><i class="bi bi-chevron-left"></i> Previous</button>
        <span>Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
        <button class="btn btn-secondary" id="next-page"><i class="bi bi-chevron-right"></i> Next</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Chart.js Setup
    const statusData = {
        labels: ['Pending', 'In Progress', 'Finished', 'Done'],
        datasets: [{
            label: 'Task Status',
            data: [{{ status_counts.pending }}, {{ status_counts.in_progress }}, {{ status_counts.finished }}, {{ status_counts.done }}],
            backgroundColor: ['#e67e22', '#3498db', '#27ae60', '#2ecc71']
        }]
    };

    const priorityData = {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
            label: 'Task Priority',
            data: [{{ priority_counts.low }}, {{ priority_counts.medium }}, {{ priority_counts.high }}],
            backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c']
        }]
    };

    const statusChart = new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: statusData,
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Task Status Distribution' }
            }
        }
    });

    const priorityChart = new Chart(document.getElementById('priorityChart'), {
        type: 'bar',
        data: priorityData,
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Number of Tasks' } }
            },
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Task Priority Distribution' }
            }
        }
    });

    // Pagination
    const rowsPerPage = 10;
    let currentPage = 1;

    function updatePagination() {
        const tbody = document.getElementById('report-table-body');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const totalPages = Math.ceil(rows.length / rowsPerPage) || 1;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('current-page').textContent = currentPage;

        rows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? '' : 'none';
        });

        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = parseInt(document.getElementById('total-pages').textContent);
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination();
        }
    });

    // CSV Export
    document.getElementById('export-csv').addEventListener('click', () => {
        const rows = document.querySelectorAll('#report-table-body tr');
        let csv = 'Title,Assigned To,Group,Status,Priority,Due Date,Created At\n';
        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            const rowData = [
                cols[0].textContent,
                cols[1].textContent,
                cols[2].textContent,
                cols[3].textContent,
                cols[4].textContent,
                cols[5].textContent,
                cols[6].textContent
            ].map(item => `"${item.replace(/"/g, '""')}"`);
            csv += rowData.join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'task_report.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    // Initial Setup
    updatePagination();
</script>

<style>
    :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #e74c3c;
        --background: #f5f6fa;
        --card-bg: #ffffff;
        --text: #2d3436;
        --muted: #7f8c8d;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
    h2 { font-size: 2.5rem; color: var(--primary); margin-bottom: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    h4 { font-size: 1.3rem; color: var(--primary); margin-bottom: 15px; }
    .section-separator { border: 0; height: 2px; background: linear-gradient(to right, var(--secondary), transparent); margin: 20px 0; }

    .report-controls { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 20px; 
        margin-bottom: 20px; 
        flex-wrap: wrap; 
        background: var(--card-bg); 
        padding: 15px; 
        border-radius: 10px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    }

    .filter-section { 
        display: flex; 
        gap: 20px; 
        flex-wrap: wrap; 
        align-items: center; 
        flex: 3; 
    }

    .filter-group { 
        display: flex; 
        flex-direction: column; 
        gap: 5px; 
        min-width: 200px; 
    }

    .filter-label { 
        font-weight: 500; 
        color: var(--text); 
        display: flex; 
        align-items: center; 
        gap: 5px; 
        font-size: 0.9rem; 
    }

    .filter-select { 
        padding: 10px 15px; 
        border-radius: 8px; 
        border: 1px solid var(--muted); 
        background: var(--card-bg); 
        color: var(--text); 
        font-size: 1rem; 
        transition: border-color 0.3s ease, box-shadow 0.3s ease; 
    }

    .filter-select:focus { 
        border-color: var(--secondary); 
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); 
        outline: none; 
    }

    .action-buttons { 
        display: flex; 
        gap: 10px; 
        flex-wrap: wrap; 
    }

    .btn-primary { 
        background: var(--secondary); 
        color: white; 
        border: none; 
        padding: 12px 25px; 
        border-radius: 25px; 
        font-size: 1rem; 
        transition: all 0.3s ease; 
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }

    .btn-primary:hover { 
        background: #2980b9; 
        transform: translateY(-2px); 
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); 
    }

    .summary-section { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 20px; 
        margin-bottom: 30px; 
    }

    .summary-card { 
        background: var(--card-bg); 
        padding: 20px; 
        border-radius: 10px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        text-align: center; 
    }

    .summary-card h4 { 
        font-size: 1.2rem; 
        margin-bottom: 10px; 
    }

    .summary-card p { 
        font-size: 1.5rem; 
        color: var(--primary); 
        font-weight: bold; 
    }

    .charts-section { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
        margin-bottom: 30px; 
    }

    .chart-card { 
        background: var(--card-bg); 
        padding: 20px; 
        border-radius: 10px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    }

    .report-table-container { 
        background: var(--card-bg); 
        border-radius: 15px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
        overflow-x: auto; 
        padding: 20px; 
    }

    .report-table { 
        width: 100%; 
        border-collapse: collapse; 
    }

    .report-table th, .report-table td { 
        padding: 15px; 
        text-align: left; 
        border-bottom: 1px solid #e9ecef; 
    }

    .report-table th { 
        background: var(--primary); 
        color: white; 
        font-weight: 600; 
    }

    .report-table tr:hover { 
        background: #f8f9fa; 
    }

    .priority-high { color: #e74c3c; font-weight: bold; }
    .priority-medium { color: #f1c40f; font-weight: bold; }
    .priority-low { color: #2ecc71; font-weight: bold; }
    .status-pending { color: #e67e22; }
    .status-in_progress { color: #3498db; }
    .status-finished { color: #27ae60; }
    .status-done { color: #2ecc71; }

    .pagination { 
        text-align: center; 
        margin-top: 20px; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        gap: 15px; 
    }

    .btn-secondary { 
        background: var(--muted); 
        color: white; 
        border: none; 
        padding: 8px 15px; 
        border-radius: 20px; 
        transition: background 0.3s ease; 
    }

    .btn-secondary:hover { 
        background: #6c757d; 
    }

    .btn-secondary:disabled { 
        background: #d3d3d3; 
        cursor: not-allowed; 
    }

    @media (max-width: 768px) {
        .report-controls { 
            flex-direction: column; 
            align-items: stretch; 
        }
        .filter-section { 
            flex-direction: column; 
            gap: 15px; 
        }
        .filter-group { 
            width: 100%; 
        }
        .action-buttons { 
            width: 100%; 
            justify-content: center; 
        }
        .summary-section { 
            grid-template-columns: 1fr; 
        }
        .charts-section { 
            grid-template-columns: 1fr; 
        }
    }
</style>
{% endblock %}